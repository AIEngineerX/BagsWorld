name: Oracle Auto-Generate

on:
  schedule:
    - cron: "0 * * * *"

  workflow_dispatch:

jobs:
  auto-generate:
    runs-on: ubuntu-latest

    steps:
      - name: Generate New Markets
        run: |
          echo "Checking if new markets should be generated..."

          RESPONSE=$(curl -s -X POST "${{ secrets.BAGSWORLD_URL }}/api/oracle/auto-generate" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.ORACLE_AUTO_GENERATE_SECRET }}" \
            -d '{}')

          echo "Response: $RESPONSE"

          GENERATED=$(echo $RESPONSE | jq -r '.generated | length // 0')
          SKIPPED=$(echo $RESPONSE | jq -r '.skipped | length // 0')
          echo "Generated $GENERATED market(s), skipped $SKIPPED"

          if [ "$GENERATED" -gt 0 ]; then
            echo "Generated markets:"
            echo $RESPONSE | jq -r '.generated[]'
          fi
